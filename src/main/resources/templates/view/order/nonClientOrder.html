<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html" th:fragment="nonClientOrderFragment ()">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>V2 회원 주문 페이지</title>
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <style>
        h3 {
            color: #ecb54f !important; /* !important를 사용하여 우선순위를 높입니다 */
        }
        .sub-container {
            margin: 10% 5% 10% 5%;
        }
        .readonly-input {
            width: 100%;
            border: none;
            background-color: transparent;
            color: inherit;
            font-size: inherit;
            font-family: inherit;
        }
        input:focus {
            outline: none;
        }
        textarea:focus {
            outline: none;
            resize: none;
        }
        .not-border-input {
            width: 100%;
            border: none;
            background-color: transparent;
            color: inherit;
            font-size: inherit;
            font-family: inherit;
        }
    </style>
</head>
<body>

<form th:action="@{/api/non-client/orders}" th:object="${nonClientOrderForm}" method="post">

    <div class="sub-container">
        <h3>주문 상품 목록</h3>
        <table class="table table-striped" id="order-item-table" th:border="1">
            <thead>
            <tr>
                <th style="width: 40%">상품명</th>
                <th style="width: 10%">상품가격</th>
                <th style="width: 10%">수량</th>
                <th style="width: 30%">포장여부</th>
            </tr>
            </thead>
            <tbody id="orderItemList">
                <tr th:each="orderDetailDto, iterStat:*{orderDetailDtoItemList}"
                    th:attr="data-product-id=${orderDetailDto.productId},
                             data-product-index=${iterStat.index},
                             data-product-price=${orderDetailDto.productSinglePrice},
                             data-product-quantity=${orderDetailDto.quantity}">
                    <td>
                        <label>
                            <textarea type="text" class="readonly-input" th:field="*{orderDetailDtoItemList[__${iterStat.index}__].productName}" readonly/>
                        </label>
                    </td>
                    <td>
                        <label>
                            <input type="text" class="readonly-input" th:field="*{orderDetailDtoItemList[__${iterStat.index}__].productSinglePrice}" readonly/>
                        </label>
                    </td>
                    <td>
                        <label>
                            <input type="text" class="readonly-input" th:field="*{orderDetailDtoItemList[__${iterStat.index}__].quantity}" readonly/>
                        </label>
                    </td>
                    <td hidden="hidden">
                        <label>
                            <input type="text" th:field="*{orderDetailDtoItemList[__${iterStat.index}__].productId}" th:value="${orderDetailDto.productId}"/>
                        </label>
                    </td>
                    <td th:hidden="!${orderDetailDto.packableProduct}">
                        <label>
                            <input type="checkbox" th:onclick="handleOnChangeUsedPackaging(this.checked, [[${iterStat.index}]])" th:field="*{orderDetailDtoItemList[__${iterStat.index}__].usePackaging}" th:value="false"> 포장지선택
                            <input hidden="hidden" th:field="*{orderDetailDtoItemList[__${iterStat.index}__].optionProductId}"/>
                            <input hidden="hidden" th:field="*{orderDetailDtoItemList[__${iterStat.index}__].optionProductName}"/>
                            <input hidden="hidden" th:field="*{orderDetailDtoItemList[__${iterStat.index}__].optionProductSinglePrice}"/>
                        </label>
                        <div hidden="hidden" th:id="'packageSelectContainer[' + ${iterStat.index} + ']'">
                            <select class="form-select form-select-sm" aria-label=".form-select-sm example" th:onchange="handleOnPackageProductSelectChange(this, [[${iterStat.index}]])">
                                <option th:attr="data-option-product-id = '-1',
                                                 data-option-product-price = '0'">
                                    == 포장지 선택 ==
                                </option>
                                <option th:each="packageDto : ${packageList}" th:value="${packageDto.productId}" th:text="${packageDto.packageName} + ' - ' + ${packageDto.productPriceSales} + '원'"
                                        th:attr="data-option-product-id = ${packageDto.productId},
                                                 data-option-product-price=${packageDto.productPriceSales},
                                                 data-option-product-name=${packageDto.packageName}"
                                >
                                </option>
                            </select>
                        </div>
                    </td>
                    <td th:hidden="${orderDetailDto.packableProduct}">
                        포장불가능한 상품입니다
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="sub-container">
        <h3>예상 결제가격</h3>
        <div>(<span id="minPurchasePrice" th:text="${shippingPolicy.minPurchaseAmount}"></span>원 이상 구매시 무료배송)</div>
        <div>
            <span>배송비: </span>
            <span>
                <label>
                    <input class="readonly-input" th:field="*{shippingFee}" readonly/>
                </label>
            </span>
        </div>
        <div>
            <span>상품 총 금액: </span>
            <span>
                <label>
                    <input class="readonly-input" th:field="*{productTotalAmount}" readonly/>
                </label>
            </span>
        </div>
        <div>
            <span>최종 결제 금액: </span>
            <span>
                <label>
                    <input class="readonly-input" th:field="*{payAmount}" readonly/>
                </label>
            </span>
        </div>
    </div>

    <div class="sub-container">
        <h3>주문자 정보</h3>
        <table class="table table-bordered border-primary" style="border: 1px solid black; width: 60%">
            <tr style="border: 1px solid black;">
                <td>
                    비회원 주문자 성함
                </td>
                <td>
                    <label style="width: 100%">
                        <input class="not-border-input" th:field="*{orderedPersonName}" type="text"/>
                    </label>
                </td>
            </tr>
            <tr style="border: 1px solid black;">
                <td>
                    비회원 전화번호
                </td>
                <td>
                    <label style="width: 100%">
                        <input class="not-border-input" th:field="*{phoneNumber}"/>
                    </label>
                </td>
            </tr>
            <tr style="border: 1px solid black;">
                <td>
                    비회원 주문 비밀번호
                </td>
                <td style="border: 1px solid black;">
                    <label style="width: 100%">
                        <input class="not-border-input" type="password" th:field="*{orderPassword}"/>
                    </label>
                </td>
            </tr>
            <tr style="border: 1px solid black;">
                <td>
                    비회원 이메일
                </td>
                <td style="border: 1px solid black;">
                    <label style="width: 100%">
                        <input class="not-border-input" type="email" th:field="*{email}"/>
                    </label>
                </td>
            </tr>
        </table>
    </div>

    <div class="sub-container">
        <h3>배송 정보</h3>
        <label>
            <input type="button" class="btn btn-outline-secondary" onclick="findNonClientAddress()" value="비회원 주소 찾기"><br>
        </label>
        <div id="nonclient-address-wrap" style="display:none;border:1px solid;width:500px;height:300px;margin:5px 0;position:relative">
            <img src="//t1.daumcdn.net/postcode/resource/images/close.png" id="btnFoldWrap" style="cursor:pointer;position:absolute;right:0px;top:-1px;z-index:1" onclick="foldDaumPostcode()" alt="접기 버튼">
        </div>
        <table class="table table-bordered border-primary" style="border: 1px solid black; width: 60%">
            <tr style="border: 1px solid black;">
                <td>우편번호</td>
                <td>
                    <label>
                        <input class="not-border-input" th:field="*{addressZipCode}"/><br/>
                    </label>
                </td>
            </tr>
            <tr style="border: 1px solid black;">
                <td>주소</td>
                <td>
                    <label>
                        <input class="not-border-input" th:field="*{deliveryAddress}"/><br/>
                    </label>
                </td>
            </tr>
            <tr style="border: 1px solid black;">
                <td>상세주소</td>
                <td>
                    <label>
                        <input class="not-border-input" th:field="*{deliveryDetailAddress}"/><br/>
                    </label>
                </td>
            </tr>
        </table>
    </div>
    <div class="sub-container">
        <h3>배송날짜 지정</h3>
        <label>
            <input type="checkbox" th:field="*{useDesignatedDeliveryDate}" onclick="toggleCalendar(this.checked, 'designatedDeliveryDate')"> (선택) 배송날짜를 지정합니다
            <div>(배송날짜를 지정하지 않을 경우 가장 빠른 날짜에 배송됩니다)</div>
        </label>
        <br/>
        <label th:for="designatedDeliveryDate">
            <input type="date" th:field="*{designatedDeliveryDate}" value="" hidden="hidden"/>
        </label>
    </div>


    <div class="sub-container">
        <div>
            <h3>결제 수단 선택</h3>
            <label>
                <input type="radio" th:field="*{paymentMethod}" value="0"> 토스 페이먼츠
            </label>
            <label>
                <input type="radio" name="paymentMethodId" value="1" disabled> 신용카드
            </label>
            <label>
                <input type="radio" name="paymentMethodId" value="2" disabled> 페이코
            </label>
        </div>
    </div>

    <div class="sub-container">
        <button type="submit" class="btn text-white" style="background-color:#ecb54f; width: 15%;" onclick="tryOrder()">결제하기</button>
    </div>

    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script>
        // 우편번호 찾기 찾기 화면을 넣을 element
        var element_wrap = document.getElementById('nonclient-address-wrap');

        function foldDaumPostcode() {
            // iframe을 넣은 element를 안보이게 한다.
            element_wrap.style.display = 'none';
        }

        function findNonClientAddress() {
            // 현재 scroll 위치를 저장해놓는다.
            var currentScroll = Math.max(document.body.scrollTop, document.documentElement.scrollTop);
            new daum.Postcode({
                oncomplete: function(data) {
                    var addr = ''; // 주소 변수
                    var extraAddr = ''; // 참고항목 변수

                    //사용자가 선택한 주소 타입에 따라 해당 주소 값을 가져온다.
                    if (data.userSelectedType === 'R') { // 사용자가 도로명 주소를 선택했을 경우
                        addr = data.roadAddress;
                    } else { // 사용자가 지번 주소를 선택했을 경우(J)
                        addr = data.jibunAddress;
                    }

                    // 사용자가 선택한 주소가 도로명 타입일때 참고항목을 조합한다.
                    if(data.userSelectedType === 'R'){
                        // 법정동명이 있을 경우 추가한다. (법정리는 제외)
                        // 법정동의 경우 마지막 문자가 "동/로/가"로 끝난다.
                        if(data.bname !== '' && /[동|로|가]$/g.test(data.bname)){
                            extraAddr += data.bname;
                        }
                        // 건물명이 있고, 공동주택일 경우 추가한다.
                        if(data.buildingName !== '' && data.apartment === 'Y'){
                            extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName);
                        }
                        // 표시할 참고항목이 있을 경우, 괄호까지 추가한 최종 문자열을 만든다.
                        if(extraAddr !== ''){
                            extraAddr = ' (' + extraAddr + ')';
                        }

                    }

                    // 우편번호와 주소 정보를 해당 필드에 넣는다.
                    document.getElementById('addressZipCode').value = data.zonecode;
                    document.getElementById("deliveryAddress").value = addr;
                    // 커서를 상세주소 필드로 이동한다.
                    document.getElementById("sample3_detailAddress").focus();

                    // iframe을 넣은 element를 안보이게 한다.
                    // (autoClose:false 기능을 이용한다면, 아래 코드를 제거해야 화면에서 사라지지 않는다.)
                    element_wrap.style.display = 'none';

                    // 우편번호 찾기 화면이 보이기 이전으로 scroll 위치를 되돌린다.
                    document.body.scrollTop = currentScroll;
                },
                // 우편번호 찾기 화면 크기가 조정되었을때 실행할 코드를 작성하는 부분. iframe을 넣은 element의 높이값을 조정한다.
                onresize : function(size) {
                    element_wrap.style.height = size.height+'px';
                },
                width : '100%',
                height : '100%'
            }).embed(element_wrap);

            // iframe을 넣은 element를 보이게 한다.
            element_wrap.style.display = 'block';
        }
    </script>

<script th:inline="javascript">

    document.addEventListener('DOMContentLoaded', function (){
        // 캘린더 선택 가능 날짜 초기화
        document.querySelector("input[type=date]").min = getMinDeliveryDate();
        // 가격 정보 업데이트
        updateProductTotalAmount();
        updateShippingFee();
        updatePayAmount();
    });

    <!--포장여부 선택 관련-->
    function handleOnChangeUsedPackaging(checked, index){
        const packageSelectContainer = document.getElementById("packageSelectContainer[" + index + "]");
        packageSelectContainer.hidden = !checked;
        if(checked) {
            packageSelectContainer.querySelector('select').selectedIndex = 0;
        }
        document.getElementById("orderDetailDtoItemList" + index + ".optionProductId").value = null;
        document.getElementById("orderDetailDtoItemList" + index + ".optionProductName").value = null;
        document.getElementById("orderDetailDtoItemList" + index + ".optionProductSinglePrice").value = 0;
        updateProductTotalAmount();
        updateShippingFee();
        updatePayAmount();
    }

    <!--포장 옵션 상품선택 변경 관련-->
    function handleOnPackageProductSelectChange(selectElement, index){
        const selectedOption = selectElement.options[selectElement.selectedIndex];
        document.getElementById("orderDetailDtoItemList" + index + ".optionProductId").value = selectedOption.dataset.optionProductId;
        document.getElementById("orderDetailDtoItemList" + index + ".optionProductName").value = selectedOption.dataset.optionProductName;
        document.getElementById("orderDetailDtoItemList" + index + ".optionProductSinglePrice").value = selectedOption.dataset.optionProductPrice;
        updateProductTotalAmount();
        updateShippingFee();
        updatePayAmount();
    }

    <!--캘린더 관련-->
    function getMinDeliveryDate(){
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        const year = tomorrow.getFullYear();
        const month = String(tomorrow.getMonth() + 1).padStart(2, '0');
        const day = String(tomorrow.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function toggleCalendar(checked, calendar){
        document.getElementById(calendar).hidden = !checked;
    }

    <!--금액 관련-->
    function updateShippingFee(){
        const originShippingFee = [[${shippingPolicy.shippingFee}]];
        const minPurchaseAmount = [[${shippingPolicy.minPurchaseAmount}]];
        const productTotalAmount = document.getElementById("productTotalAmount").value;
        if(productTotalAmount >= minPurchaseAmount){
            document.getElementById("shippingFee").value = 0;
        }else{
            document.getElementById("shippingFee").value = originShippingFee;
        }
        updatePayAmount();
    }

    function updateProductTotalAmount(){
        let totalPrice = 0;
        document.querySelectorAll('tr[data-product-index]').forEach(function(row, index) {
            // 순수 상품 총 가격
            const price = parseInt(row.dataset.productPrice);
            const quantity = parseInt(row.dataset.productQuantity);
            const subtotal = price * quantity;
            totalPrice += subtotal;
            // 포장지 총 가격
            const checkBox = row.querySelector('input[type="checkbox"]');
            if(checkBox.checked){
                const optionProductPrice = parseInt(document.getElementById("orderDetailDtoItemList" + index + ".optionProductSinglePrice").value);
                totalPrice += optionProductPrice;
            }
        });
        document.getElementById("productTotalAmount").value = totalPrice
    }

    function updatePayAmount(){
        const shippingFee = parseInt(document.getElementById("shippingFee").value);
        const productTotalAmount = parseInt(document.getElementById("productTotalAmount").value);

        // 최종 결제 금액
        document.getElementById("payAmount").value = productTotalAmount + shippingFee;
    }

</script>

</body>
</html>