<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>V2 회원 주문 페이지</title>
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <style>
        h3 {
            color: #ecb54f !important; /* !important를 사용하여 우선순위를 높입니다 */
        }
        .sub-container {
            margin: 10% 5% 10% 5%;
        }
        .readonly-input {
            width: 100%;
            border: none;
            background-color: transparent;
            color: inherit;
            font-size: inherit;
            font-family: inherit;
        }
        input:focus {
            outline: none;
        }
        textarea:focus {
            outline: none;
            resize: none;
        }
        .not-border-input {
            width: 100%;
            border: none;
            background-color: transparent;
            color: inherit;
            font-size: inherit;
            font-family: inherit;
        }
    </style>
</head>
<body>
<div th:replace="~{layout/header.html :: headerFragment ('user', 'message')}"></div>

<form th:action="@{/api/client/orders}" th:object="${nonClientOrderForm}" method="post">

    <div class="sub-container">
        <h3>주문 상품 목록</h3>
        <table class="table table-striped" id="order-item-table" th:border="1">
            <thead>
            <tr>
                <th style="width: 40%">상품명</th>
                <th style="width: 10%">상품가격</th>
                <th style="width: 10%">수량</th>
                <th style="width: 30%">포장여부</th>
            </tr>
            </thead>
            <tbody id="orderItemList">
                <tr th:each="orderDetailDto, iterStat:*{orderDetailDtoItemList}"
                    th:attr="data-product-id=${orderDetailDto.productId},
                             data-product-index=${iterStat.index},
                             data-product-price=${orderDetailDto.productSinglePrice},
                             data-product-quantity=${orderDetailDto.quantity}">
                    <td>
                        <label>
                            <textarea type="text" class="readonly-input" th:field="*{orderDetailDtoItemList[__${iterStat.index}__].productName}" readonly/>
                        </label>
                    </td>
                    <td>
                        <label>
                            <input type="text" class="readonly-input" th:field="*{orderDetailDtoItemList[__${iterStat.index}__].productSinglePrice}" readonly/>
                        </label>
                    </td>
                    <td>
                        <label>
                            <input type="text" class="readonly-input" th:field="*{orderDetailDtoItemList[__${iterStat.index}__].quantity}" readonly/>
                        </label>
                    </td>
                    <td hidden="hidden">
                        <label>
                            <input type="text" th:field="*{orderDetailDtoItemList[__${iterStat.index}__].productId}" th:value="${orderDetailDto.productId}"/>
                        </label>
                    </td>
                    <td>
                        <label>
                            <input type="checkbox" th:onclick="handleOnChangeUsedPackaging(this.checked, [[${iterStat.index}]])" th:field="*{orderDetailDtoItemList[__${iterStat.index}__].usePackaging}" th:value="false"> 포장지선택
                            <input hidden="hidden" th:field="*{orderDetailDtoItemList[__${iterStat.index}__].optionProductId}"/>
                            <input hidden="hidden" th:field="*{orderDetailDtoItemList[__${iterStat.index}__].optionProductName}"/>
                            <input hidden="hidden" th:field="*{orderDetailDtoItemList[__${iterStat.index}__].optionProductSinglePrice}"/>
                        </label>
                        <div hidden="hidden" th:id="'packageSelectContainer[' + ${iterStat.index} + ']'">
                            <select class="form-select form-select-sm" aria-label=".form-select-sm example" th:onchange="handleOnPackageProductSelectChange(this, [[${iterStat.index}]])">
                                <option th:attr="data-option-product-id = '-1',
                                                 data-option-product-price = '0'">
                                    == 포장지 선택 ==
                                </option>
                                <option th:each="packageDto : ${packageList}" th:value="${packageDto.productId}" th:text="${packageDto.packageName} + ' - ' + ${packageDto.productPriceSales} + '원'"
                                        th:attr="data-option-product-id = ${packageDto.productId},
                                                 data-option-product-price=${packageDto.productPriceSales},
                                                 data-option-product-name=${packageDto.packageName}"
                                >
                                </option>
                            </select>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="sub-container">
        <h3>예상 결제가격</h3>
        <div>(<span id="minPurchasePrice" th:text="${shippingPolicy.minPurchaseAmount}"></span>원 이상 구매시 무료배송)</div>
        <div>
            <span>배송비: </span>
            <span>
                <label>
                    <input class="readonly-input" th:field="*{shippingFee}" readonly/>
                </label>
            </span>
        </div>
        <div>
            <span>상품 총 금액: </span>
            <span>
                <label>
                    <input class="readonly-input" th:field="*{productTotalAmount}" readonly/>
                </label>
            </span>
        </div>
        <div>
            <span>최종 결제 금액: </span>
            <span>
                <label>
                    <input class="readonly-input" th:field="*{payAmount}" readonly/>
                </label>
            </span>
        </div>
    </div>

    <div class="sub-container">
        <h3>주문자 정보</h3>
        <table style="border: 1px solid black; width: 60%">
            <tr style="border: 1px solid black;">
                <td>
                    비회원 주문자 성함
                </td>
                <td>
                    <label style="border: 1px solid black;">
                        <input class="not-border-input" th:field="*{orderedPersonName}" type="text"/>
                    </label>
                </td>
            </tr>
            <tr style="border: 1px solid black;">
                <td>
                    비회원 전화번호
                </td>
                <td>
                    <label style="border: 1px solid black;">
                        <input class="not-border-input" th:field="*{phoneNumber}"/>
                    </label>
                </td>
            </tr>
            <tr style="border: 1px solid black;">
                <td>
                    비회원 주문 비밀번호
                </td>
                <td style="border: 1px solid black;">
                    <label>
                        <input class="not-border-input" type="password" th:field="*{orderPassword}"/>
                    </label>
                </td>
            </tr>
        </table>
    </div>

    <div class="sub-container">
        <h3>배송 정보</h3>
        <table style="border: 1px solid black; width: 60%">
            <tr style="border: 1px solid black;">
                <td>우편번호</td>
                <td style="border: 1px solid black;">
                    <label>
                        <input class="not-border-input" th:field="*{addressZipCode}"/><br/>
                    </label>
                </td>
            </tr>
            <tr style="border: 1px solid black;">
                <td>배송주소</td>
                <td style="border: 1px solid black;">
                    <label>
                        <input class="not-border-input" th:field="*{deliveryAddress}"/><br/>
                    </label>
                </td>
            </tr>
            <tr style="border: 1px solid black;">
                <td>상세주소</td>
                <td style="border: 1px solid black;">
                    <label>
                        <input class="not-border-input" th:field="*{deliveryDetailAddress}"/><br/>
                    </label>
                </td>
            </tr>
        </table>
    </div>
    <div class="sub-container">
        <h3>배송날짜 지정</h3>
        <label>
            <input type="checkbox" th:field="*{useDesignatedDeliveryDate}" onclick="toggleCalendar(this.checked, 'designatedDeliveryDate')"> (선택) 배송날짜를 지정합니다
            <div>(배송날짜를 지정하지 않을 경우 가장 빠른 날짜에 배송됩니다)</div>
        </label>
        <br/>
        <label th:for="designatedDeliveryDate">
            <input type="date" th:field="*{designatedDeliveryDate}" value="" hidden="hidden"/>
        </label>
    </div>


    <div class="sub-container">
        <div>
            <h3>결제 수단 선택</h3>
            <label>
                <input type="radio" th:field="*{paymentMethod}" value="0"> 토스 페이먼츠
            </label>
            <label>
                <input type="radio" name="paymentMethodId" value="1" disabled> 신용카드
            </label>
            <label>
                <input type="radio" name="paymentMethodId" value="2" disabled> 페이코
            </label>
        </div>
    </div>

    <div class="sub-container">
        <button type="submit" class="btn text-white" style="background-color:#ecb54f; width: 15%;" onclick="tryOrder()">결제하기</button>
    </div>

<script th:inline="javascript">

    document.addEventListener('DOMContentLoaded', function (){
        // 캘린더 선택 가능 날짜 초기화
        document.querySelector("input[type=date]").min = getMinDeliveryDate();
        // 가격 정보 업데이트
        updateProductTotalAmount();
        updateShippingFee();
        updatePayAmount();
    });

    <!--포장여부 선택 관련-->
    function handleOnChangeUsedPackaging(checked, index){
        const packageSelectContainer = document.getElementById("packageSelectContainer[" + index + "]");
        packageSelectContainer.hidden = !checked;
        if(checked) {
            packageSelectContainer.querySelector('select').selectedIndex = 0;
        }
        document.getElementById("orderDetailDtoItemList" + index + ".optionProductId").value = null;
        document.getElementById("orderDetailDtoItemList" + index + ".optionProductName").value = null;
        document.getElementById("orderDetailDtoItemList" + index + ".optionProductSinglePrice").value = 0;
        updateProductTotalAmount();
        updateShippingFee();
        updatePayAmount();
    }

    <!--포장 옵션 상품선택 변경 관련-->
    function handleOnPackageProductSelectChange(selectElement, index){
        const selectedOption = selectElement.options[selectElement.selectedIndex];
        document.getElementById("orderDetailDtoItemList" + index + ".optionProductId").value = selectedOption.dataset.optionProductId;
        document.getElementById("orderDetailDtoItemList" + index + ".optionProductName").value = selectedOption.dataset.optionProductName;
        document.getElementById("orderDetailDtoItemList" + index + ".optionProductSinglePrice").value = selectedOption.dataset.optionProductPrice;
        updateProductTotalAmount();
        updateShippingFee();
        updatePayAmount();
    }

    <!--캘린더 관련-->
    function getMinDeliveryDate(){
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        const year = tomorrow.getFullYear();
        const month = String(tomorrow.getMonth() + 1).padStart(2, '0');
        const day = String(tomorrow.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function toggleCalendar(checked, calendar){
        document.getElementById(calendar).hidden = !checked;
    }

    <!--포인트 관련-->
    function validatePoints() {
        const remainingPoints = parseInt(document.getElementById('remaining-points').textContent);
        const usePoints = parseInt(document.getElementById('use-points').value);
        const errorMessage = document.getElementById('error-message');
        if (usePoints > remainingPoints) {
            errorMessage.style.display = 'block';
            document.getElementById('use-points').value = remainingPoints;
        } else {
            errorMessage.style.display = 'none';
        }
        updateCurrentData();
    }

    <!--주소 선택 관련-->
    function handleSelectAddress(selectedClientAddressDto) {
        showSelectedAddressInfo();
        updateSelectedAddressInfoData(selectedClientAddressDto);
    }

    function showSelectedAddressInfo() {
        const selectedAddressInfo = document.getElementById("selectedAddressInfo");
        selectedAddressInfo.children[0].hidden = true;
        selectedAddressInfo.children[1].hidden = false;
    }

    function updateSelectedAddressInfoData(selectedClientAddressElement) {
        document.getElementById("addressNickname").value = selectedClientAddressElement.children[0].innerText;
        document.getElementById("addressZipCode").value = selectedClientAddressElement.children[1].innerText;
        document.getElementById("deliveryAddress").value = selectedClientAddressElement.children[2].innerText + ", " +  selectedClientAddressElement.children[3].innerText;
    }

    <!--번호 선택 관련-->
    function handleSelectPhoneNumber(phoneNumberElement){
        showSelectedPhoneNumberInfo();
        updateSelectedPhoneNumberInfoData(phoneNumberElement);
    }

    function showSelectedPhoneNumberInfo(){
        const selectedPhoneNumberInfo = document.getElementById("selectedPhoneNumberForm")
        selectedPhoneNumberInfo.children[0].hidden = true;
        selectedPhoneNumberInfo.children[1].hidden = false;
    }

    function updateSelectedPhoneNumberInfoData(phoneNumberElement){
        document.getElementById("phoneNumber").value = phoneNumberElement.children[0].innerText;
    }

    <!--금액 관련-->
    function updateShippingFee(){
        const originShippingFee = [[${shippingPolicy.shippingFee}]];
        const minPurchaseAmount = [[${shippingPolicy.minPurchaseAmount}]];
        const productTotalAmount = document.getElementById("productTotalAmount").value;
        if(productTotalAmount >= minPurchaseAmount){
            document.getElementById("shippingFee").value = 0;
        }else{
            document.getElementById("shippingFee").value = originShippingFee;
        }
        updatePayAmount();
    }

    function updateProductTotalAmount(){
        let totalPrice = 0;
        document.querySelectorAll('tr[data-product-index]').forEach(function(row, index) {
            // 순수 상품 총 가격
            const price = parseInt(row.dataset.productPrice);
            const quantity = parseInt(row.dataset.productQuantity);
            const subtotal = price * quantity;
            totalPrice += subtotal;
            // 포장지 총 가격
            const checkBox = row.querySelector('input[type="checkbox"]');
            if(checkBox.checked){
                const optionProductPrice = parseInt(document.getElementById("orderDetailDtoItemList" + index + ".optionProductSinglePrice").value);
                totalPrice += optionProductPrice;
            }
        });
        document.getElementById("productTotalAmount").value = totalPrice
    }

    function updatePayAmount(){
        let pointDiscountAmount = document.getElementById("usedPointDiscountAmount").value;
        let couponDiscountAmount = document.getElementById("couponDiscountAmount").value;
        const shippingFee = parseInt(document.getElementById("shippingFee").value);
        const productTotalAmount = parseInt(document.getElementById("productTotalAmount").value);

        if(pointDiscountAmount == null) pointDiscountAmount = 0;
        if(couponDiscountAmount == null) couponDiscountAmount = 0;

        console.log("shippingFee: ", shippingFee);
        console.log("productTotalAmount: ", productTotalAmount);
        console.log("pointDiscountAmount: ", pointDiscountAmount);
        console.log("couponDiscountAmount: ", couponDiscountAmount);

        // 최종 결제 금액
        document.getElementById("payAmount").value = productTotalAmount + shippingFee - pointDiscountAmount - couponDiscountAmount;
    }

</script>

<div th:replace="~{layout/footer.html :: footerFragment}"></div>
</body>
</html>