<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Order Page</title>
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">
    <style>
        h3 {
            color: #ecb54f !important; /* !important를 사용하여 우선순위를 높입니다 */
        }
        .sub-container {
            margin: 10% 5% 10% 5%;
        }
    </style>
</head>
<body>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>

<div th:replace="~{layout/header.html :: headerFragment ('user', 'message')}"></div>

<div class="container">
    <div class="sub-container">
        <h3>주문 목록</h3>
        <table class="table table-striped" id="order-item-table" th:border="1">
            <thead>
            <tr>
                <th style="width: 10%">상품이미지</th>
                <th style="width: 40%">상품명</th>
                <th style="width: 10%">상품가격</th>
                <th style="width: 10%">수량</th>
                <th style="width: 30%">포장여부</th>
            </tr>
            </thead>
            <tbody id="orderItemList">
            <tr th:each="productItemDto, iterStat : ${orderResponseDto.productItemDtoList}">
                <td th:text="${productItemDto.imgPath}"></td>
                <td th:text="${productItemDto.name}"></td>
                <td th:text="${productItemDto.price}"></td>
                <td th:text="${productItemDto.quantity}"></td>
                <td>
                    <label>
                        <input type="checkbox" onclick="handleOnChange()"> 포장지선택
                    </label>
                    <div>
                        <select class="form-select form-select-sm" aria-label=".form-select-sm example" onchange="handleOnChange()" hidden="hidden">
                            <option value="0">== 포장지 선택 ==</option>
                            <option th:each="packageItemDto : ${orderResponseDto.packageItemDtoList}" th:id="${packageItemDto.id}" th:value="${packageItemDto.price}" th:text="${packageItemDto.name} + ' - ' + ${packageItemDto.price} + '원'"></option>
                        </select>
                    </div>
                </td>
            </tr>
            </tbody>
        </table>
    </div>

    <div class="sub-container">
        <h3>예상가격</h3>
        <div>(<span id="minPurchasePrice" th:text="${orderResponseDto.minPurchasePrice}"></span>원 이상 구매시 무료배송입니다)</div>
        <div>배송비: <span id="shippingFee" th:text="${orderResponseDto.shippingFee}"></span>원</div>
        <div>상품 총 금액: <span id="totalProductPrice"></span>원</div>
        <div class="text-nowrap bd-highlight fs-5" style="width: 8rem;">총 금액(예상 결제 금액): <span id="totalPrice">0</span>원</div>
    </div>

    <div class="sub-container">
        <h3>주문정보</h3>
        <div>구매자 성함: <span>코드퀘스트</span></div>
        <div>구매자 이메일: <span>cq@codequest.com</span></div>
        <div>배송지
            <span class="btn-group" role="group" aria-label="Basic outlined example">
                <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addressRegisterModal" style="font-size: small; padding: 0; height: 30px; width: 90px">주소등록</button>
                <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addressSelectModal" style="font-size: small; padding: 0; height: 30px; width: 90px">주소선택</button>
            </span>
        </div>
        <div id="selectedAddressInfo">
            <div>(필수) 주소를 선택해 주세요</div>
            <div class="border border-secondary-subtle rounded" style="width: 60%; padding: 1%; margin: 1%" hidden="hidden">
                <div>배송지: <span id="selectedAddressNickName"></span></div>
                <div>우편번호: <span id="selectedAddressZipCode"></span></div>
                <div>주소: <span id="selectedDeliveryAddress"></span></div>
            </div>
        </div>
        <div>전화번호
            <span class="btn-group" role="group" aria-label="Basic outlined example">
                <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#phoneNumberRegisterModal" style="font-size: small; padding: 0; height: 30px; width: 90px">번호등록</button>
                <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#phoneNumberSelectModal" style="font-size: small; padding: 0; height: 30px; width: 90px">번호선택</button>
            </span>
        </div>
        <div id="selectedPhoneNumberInfo">
            <div>(필수) 전화번호를 선택해 주세요</div>
            <div class="border border-secondary-subtle rounded" style="width: 30%; padding: 1%; margin: 1%" id="selectedPhoneNumberForm" hidden="hidden">
                <div><span id="selectedPhoneNumberNickName"></span></div>
                <div><span id="selectedPhoneNumber"></span></div>
            </div>
        </div>
    </div>

    <div class="sub-container">
        <h3>배송날짜 지정</h3>
        <label>
            <input type="checkbox" onclick="selectDeliveryDate(this.checked)"> (선택) 배송날짜를 지정합니다
            <div>(배송날짜를 지정하지 않을 경우 가장 빠른 날짜에 배송됩니다)</div>
        </label>
        <div id="deliveryCalendar" hidden="hidden">
            <label>
                <input type="date" id="deliveryDate"/>
            </label>
        </div>
<!--        <div id="selectedDeliveryDate">-->
<!--            배송날짜: <span>0000년 00월 00일</span>-->
<!--        </div>-->
    </div>

    <form class="sub-container" method="get" action="/">
        <button class="btn" style="background-color:#ecb54f">다음단계</button>
    </form>

    <!-- Modal -->
    <!-- 주소등록 Modal -->
    <div class="modal fade" id="addressRegisterModal" tabindex="-1" aria-labelledby="addressRegisterModal" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="addressRegisterModalLabel">Modal title</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    주소등록 모달
                </div>
            </div>
        </div>
    </div>
    <!-- 주소선택 Modal -->
    <div class="modal fade" id="addressSelectModal" tabindex="-1" aria-labelledby="addressSelectModal" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="addressSelectModalModalLabel">주소를 선택해 주세요</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="border border-secondary-subtle rounded" th:each="clientAddressDto, iterStat : ${orderResponseDto.clientAddressDtoList}" style="margin: 10px; padding: 10px">
                        <div id="addressForm">
                            <div>[[${clientAddressDto.addressNickname}]]</div>
                            <div>[[${clientAddressDto.zipCode}]]</div>
                            <div>[[${clientAddressDto.address}]]</div>
                            <div>[[${clientAddressDto.detailAddress}]]</div>
                        </div>
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" onclick="handleSelectAddress(this.previousElementSibling)">선택</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- 번호등록 Modal -->
    <div class="modal fade" id="phoneNumberRegisterModal" tabindex="-1" aria-labelledby="phoneNumberRegisterModal" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="phoneNumberRegisterModalLabel">Modal title</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    번호등록 모달
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary">Save changes</button>
                </div>
            </div>
        </div>
    </div>
    <!-- 번호선택 Modal -->
    <div class="modal fade" id="phoneNumberSelectModal" tabindex="-1" aria-labelledby="phoneNumberSelectModal" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="phoneNumberSelectModalModalLabel">전화번호를 선택해 주세요</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="border border-secondary-subtle rounded" th:each="phoneNumberDto, iterStat : ${orderResponseDto.phoneNumberDtoList}" style="margin: 10px; padding: 10px">
                        <div id="phoneNumberForm">
                            <div>[[${phoneNumberDto.alias}]]</div>
                            <div>[[${phoneNumberDto.phoneNumber}]]</div>
                        </div>
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" onclick="handleSelectPhoneNumber(this.previousElementSibling)">선택</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">

    const shippingFee = [[${orderResponseDto.shippingFee}]];
    const minPurchasePrice = [[${orderResponseDto.minPurchasePrice}]];
    let currentShippingFee;
    let currentTotalProductPrice;

    document.addEventListener('DOMContentLoaded', function() {
        updateCurrentData();
        processUpdatePriceRelatedState();
    });

    function handleOnChange() {
        updateCurrentData();
        processUpdatePriceRelatedState();
    }

    function updateCurrentData() {
        currentTotalProductPrice = getTotalProductPrice();

        if (minPurchasePrice <= currentTotalProductPrice) {
            currentShippingFee = 0;
        } else {
            currentShippingFee = shippingFee;
        }
    }

    function processUpdatePriceRelatedState() {
        updateCurrentShippingFee();
        updateTotalProductPrice();
        updateTotalPrice();
    }

    function updateTotalPrice() {
        const totalPriceElement = document.getElementById('totalPrice');
        totalPriceElement.innerText = currentTotalProductPrice + currentShippingFee;
    }

    function updateCurrentShippingFee() {
        const shippingFeeElement = document.getElementById('shippingFee');
        shippingFeeElement.innerText = currentShippingFee;
    }

    function updateTotalProductPrice() {
        const totalProductPriceElement = document.getElementById('totalProductPrice');
        totalProductPriceElement.innerText = currentTotalProductPrice;
    }

    function getTotalProductPrice() {
        const rows = document.querySelectorAll('#orderItemList tr');
        let totalAmount = 0;
        rows.forEach(row => {
            const price = parseFloat(row.cells[2].innerText);
            const quantity = parseInt(row.cells[3].innerText);
            totalAmount += price * quantity;

            const checkbox = row.querySelector('input[type="checkbox"]');
            const select = row.querySelector('select');

            select.hidden = !checkbox.checked;

            if (checkbox.checked) {
                const option = select.options[select.selectedIndex];
                const packagePrice = parseInt(option.value);
                totalAmount += packagePrice * quantity;
            }
        });

        return totalAmount;
    }

    function handleSelectAddress(selectedClientAddressDto) {
        showSelectedAddressInfo();
        updateSelectedAddressInfoData(selectedClientAddressDto);
    }

    function showSelectedAddressInfo() {
        const selectedAddressInfo = document.getElementById("selectedAddressInfo");
        selectedAddressInfo.children[0].hidden = true;
        selectedAddressInfo.children[1].hidden = false;
    }

    function updateSelectedAddressInfoData(selectedClientAddressElement) {
        document.getElementById("selectedAddressNickName").innerText = selectedClientAddressElement.children[0].innerText;
        document.getElementById("selectedAddressZipCode").innerText = selectedClientAddressElement.children[1].innerText;
        document.getElementById("selectedDeliveryAddress").innerText = selectedClientAddressElement.children[2].innerText + selectedClientAddressElement.children[3].innerText;
    }

    function handleSelectPhoneNumber(phoneNumberElement){
        showSelectedPhoneNumberInfo();
        updateSelectedPhoneNumberInfoData(phoneNumberElement);
    }

    function showSelectedPhoneNumberInfo(){
        const selectedPhoneNumberInfo = document.getElementById("selectedPhoneNumberInfo")
        selectedPhoneNumberInfo.children[0].hidden = true;
        selectedPhoneNumberInfo.children[1].hidden = false;
    }

    function updateSelectedPhoneNumberInfoData(phoneNumberElement){
        document.getElementById("selectedPhoneNumberNickName").innerText = phoneNumberElement.children[0].innerText;
        document.getElementById("selectedPhoneNumber").innerText = phoneNumberElement.children[1].innerText;
    }

    function selectDeliveryDate(checked) {
        const deliveryCalendarElement = document.getElementById("deliveryCalendar");
        deliveryCalendarElement.hidden = !checked;
    }

    <!--캘린더 관련-->
    const deliveryDate = document.getElementById("deliveryDate");
    deliveryDate.min = getMinDeliveryDate();

    function getMinDeliveryDate(){
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        const year = tomorrow.getFullYear();
        const month = String(tomorrow.getMonth() + 1).padStart(2, '0');
        const day = String(tomorrow.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

</script>
</body>
</html>
