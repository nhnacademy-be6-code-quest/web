<!DOCTYPE html>
<html lang="en" th:fragment="OrdersFragment ('orders')">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Order History</title>
  <link rel="stylesheet" href="styles.css">
  <style>

    .container {
      max-width: 95%;
      margin: 0 auto;
      padding: 20px;
    }

    .title {
      font-size: 24px;
      font-weight: bold;
    }

    .card {
      background-color: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .card-content {
      padding: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }

    .text-right {
      text-align: right;
    }

    .yellow-btn{
      display: inline-block;
      padding: 8px 12px;
      border: 1px solid #ccc;
      background-color: #fff;
      color: #d9bf8a;
      text-decoration: none;
      border-radius: 4px;
    }

    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 20px;
    }

    .pagination-content {
      display: flex;
      list-style-type: none;
      padding: 0;
    }

    .pagination-item {
      margin: 0 5px;
    }

    .pagination-link {
      display: inline-block;
      padding: 8px 12px;
      border: 1px solid #ccc;
      background-color: #fff;
      color: #d9bf8a;
      text-decoration: none;
      border-radius: 4px;
      transition: background-color 0.3s, color 0.3s;
    }

    .pagination-link:hover {
      background-color: #d9bf8a;
      color: #fff;
    }

    .pagination-link.active {
      background-color: #e4ac3e;
      color: #fff;
      border-color: #d9bf8a;
    }
    /* 모달 스타일 */
    .modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgb(0,0,0); background-color: rgba(0,0,0,0.4); }
    .modal-content { background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; }
    .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
    .close:hover, .close:focus { color: black; text-decoration: none; cursor: pointer; }

  </style>
</head>
<body>
<div class="container">
  <div>
    <h1 class="title">주문 내역 조회</h1>
  </div>
  <div class="card">
    <div class="card-content">
      <table>
        <thead>
        <tr>
          <th style="width:10%">주문날짜</th>
          <th style="width:10%">주문번호</th>
          <th style="width:10%">주문상태</th>
          <th style="width:70%">주문 목록</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="order : ${orders}">
          <td th:text="${order.orderDatetime}"></td>
          <td th:text="${order.orderId}"></td>
          <td th:text="${order.orderStatus}"></td>
          <td>
            <div th:each="item : ${order.clientProductOrderDetailList}">
              <hr/>
              <span th:text="${item.productName} + ' x ' + ${item.productQuantity}"></span>
              <div class="text-muted" th:text="${item.productSinglePrice} + '원 x ' + ${item.productQuantity}"></div>
              <div th:if="${item.optionProductId} != null">
                <span th:text="${item.optionProductName}"></span>
                <div class="text-muted" th:text="${item.optionProductSinglePrice} + '원'"></div>
              </div>
              <div th:if="${item.optionProductId} == null">
                포장지 구매 안함
              </div>
<!--              <div class="text-muted" th:text="'(상품 총 금액)' + ${item.productTotalAmount}"></div>-->
<!--              <div class="text-muted" th:text="'(배송비)' + ${item.shippingFee}"></div>-->
<!--              <div th:if="${item.discountAmountByPoint} != null" class="text=muted" th:text="'(포인트 할인)' + ${item.discountAmountByPoint}"></div>-->
<!--              <div th:if="${item.discountAmountByCoupon} != null" class="text=muted" th:text="'(쿠폰할인)' + ${item.discountAmountByCoupon}"></div>-->
              <a class="yellow-btn" th:href="@{/write/review(orderDetailId=${item.productOrderDetailId}, orderId=${order.orderId})}">
                리뷰 쓰러 가기
              </a>
              <hr/>
            </div>
            <button th:attr="data-point-discount=${order.discountAmountByPoint},
                                     data-coupon-discount=${order.discountAmountByCoupon},
                                     data-order-total-amount=${order.orderTotalAmount},
                                     data-order-id=${order.orderId},
                                     data-order-status=${order.orderStatus}"
                    th:if="${order.orderStatus=='결제완료'}"
                    onclick="openCancelModal(this)" class="btn">주문취소</button>

            <button th:attr="data-point-discount=${order.discountAmountByPoint},
                                     data-coupon-discount=${order.discountAmountByCoupon},
                                     data-order-total-amount=${order.orderTotalAmount},
                                     data-order-id=${order.orderId},
data-order-date=${order.designatedDeliveryDate}"
             th:if="${order.orderStatus == '배송중' || order.orderStatus == '배송완료'}"
                    onclick="openRefundModal(this)" class="btn">환불요청</button>
          </td>
        </tr>
        </tbody>
      </table>
    </div>
  </div>
<!--  취소모달-->
  <div id="cancelModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('cancelModal')">&times;</span>
      <form id="paymentCancelForm" th:action="@{/client/payment/cancel}" method="post">
        <input type="hidden" id="orderId"  name="orderId">
        <input type="hidden" id="status" name="orderStatus">
        <div>
          <label for="cancelAmount">환불 금액:</label>
          <p type="text" id="cancelAmount"></p>
        </div>
        <div>
          <label for ="cancelReason">취소 이유:
            <input id="cancelReason" type="text" name="cancelReason">
          </label>
        </div>
        <button type="submit">취소 요청</button>
      </form>
    </div>
  </div>
  <!--  반품모달-->
  <div id="refundModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('refundModal')">&times;</span>
      <form id="paymentRefundForm" th:action="@{/order/refund/request}" method="post">
        <input type="hidden" id="orderIds"  name="orderId">
        <div>
          <label for="totalAmount">환불 금액:</label>
          <p type="text" id="totalAmount"></p>
        </div>
        <div>
          <label for="refundPolicySelect">환불 정책:</label>
          <select id="refundPolicySelect" name="refundPolicyId">
            <!-- 옵션은 JavaScript로 동적으로 추가됨 -->
          </select>
        </div>
        <div>
          <label for ="cancelReason">반품 상세 사유:
            <input id="refundDetailReason" type="text" name="refundDetailReason">
          </label>
        </div>
        <button type="submit">반품 요청</button>
      </form>
    </div>
  </div>




  <div class="pagination">
    <div class="pagination-content">
    <span th:each="i : ${#numbers.sequence(0, totalPages - 1)}" class="pagination-item">
      <a th:href="|/mypage/orders?pageNo=${i}&pageSize=${pageSize}|"
         th:classappend="${i == currentPage} ? 'pagination-link active' : 'pagination-link'">
        [[${i + 1}]]
      </a>
    </span>
    </div>
  </div>

</div>
<script>
  function openCancelModal(button){
    const modal = document.getElementById('cancelModal');
    modal.style.display = "block";
    const orderId = button.getAttribute('data-order-id');
    const couponDiscount = button.getAttribute('data-coupon-discount');
    const orderStatus = button.getAttribute('data-order-status');
    const pointDiscount = button.getAttribute('data-point-discount');
    const orderTotalAmount = button.getAttribute('data-order-total-amount');
    const finalAmount = orderTotalAmount - pointDiscount - couponDiscount;
    const orderDate = button.getAttribute('data-order-date');
    document.getElementById('cancelAmount').textContent = finalAmount;
    document.getElementById('orderId').value = orderId;
    document.getElementById('status').value = orderStatus;
    document.getElementById('orderDate').value = orderDate;

  }


  function openRefundModal(button) {
    const couponDiscount = button.getAttribute('data-coupon-discount');
    const pointDiscount = button.getAttribute('data-point-discount');
    const orderTotalAmount = button.getAttribute('data-order-total-amount');
    const orderIds = button.getAttribute('data-order-id');
    const totalAmount = orderTotalAmount - pointDiscount - couponDiscount;
    fetchRefundPolicies(orderIds);
    document.getElementById('totalAmount').textContent = totalAmount;
    document.getElementById('orderIds').value = orderIds;


      // 모달을 열기
      document.getElementById('refundModal').style.display = 'block';
    function fetchRefundPolicies(orderIds) {
      fetch(`/order/refund?orderId=${orderIds}`)
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then(data => {
        console.log('Refund policies data:', data); // 데이터 확인

        populateRefundPolicySelect(data);
      })
      .catch(error => {
        console.error('Error fetching refund policies:', error);
      });
    }

// select 요소에 옵션을 추가하는 함수
    function populateRefundPolicySelect(refundPolicies) {
      const refundPolicySelect = document.getElementById('refundPolicySelect');
      refundPolicySelect.innerHTML = '<option value="">선택하세요</option>'; // 초기화

      refundPolicies.forEach(refund => {
        const option = document.createElement('option');
        // 설정할 데이터
        const refundPolicyId = refund.refundPolicyId; // ID
        const refundPolicyType = refund.refundPolicyType; // TYPE

        // 옵션의 value 설정
        option.value = refundPolicyId;

        // 옵션의 텍스트 콘텐츠 설정
        option.textContent = ` TYPE: ${refundPolicyType}`;

        // 옵션을 select 요소에 추가
        refundPolicySelect.appendChild(option);
      });
      }

   }

    function closeModal(modalId) {
      document.getElementById(modalId).style.display = "none";
    }

    window.onclick = function (event) {
      const modals = document.getElementsByClassName("modal");
      for (let i = 0; i < modals.length; i++) {
        if (event.target == modals[i]) {
          closeModal(modals[i].id);

        }
      }
    }

</script>
</body>
</html>
