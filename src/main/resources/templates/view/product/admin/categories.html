<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" th:fragment="categoryFragment">
<head>
    <meta charset="UTF-8">
    <title>관리자 페이지 - 카테고리</title>
    <style>
        .admin-category-add-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 50px;
        }

        .admin-category-add-btn {
            background-color: #007BFF; /* Blue */
            color: white;
            padding: 8px 16px;
            border: none;
            font-size: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
            height: 40px;
            align-content: center;
        }

        .admin-category-add-btn:hover {
            background-color: #0056b3; /* Darker Blue */
        }
        .category-form-control {
            color: #908F8D;
            line-height: normal;
            letter-spacing: 0.02125rem;
            text-transform: capitalize;
            margin-top: 20px;
            border-radius: 0;
            border: 0;
            background: #FFF;
            display: flex;
            align-items: center;
            gap: 0.375rem;
            align-self: stretch;
        }
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        .pagination a {
            color: #0056b3;
            padding: 8px 16px;
            text-decoration: none;
            transition: background-color .3s;
        }

        .pagination a.active {
            background-color: #0056b3;
            color: white;
            border-radius: 5px;
        }

        .pagination a:hover {
            background-color: #ddd;
            border-radius: 5px;
        }
        .search-form {
            border:0;
        }
    </style>
    <script>
        function getAllSubCategory(categoryId){
            location.href= '/admin/categories/'+ categoryId + '/sub2'
        }

        function openRegisterCategoryModal(parentCategoryName, parentCategoryNameValue) {
            document.getElementById("parentCategoryName").value = parentCategoryName;
            document.getElementById("parentCategoryNameValue").value = parentCategoryNameValue;
        }

        function openUpdateCategoryModal(categoryName, categoryNameValue) {
            document.getElementById("currentCategoryName").value = categoryName;
            document.getElementById("currentCategoryNameValue").value = categoryNameValue;
            document.getElementById("innerText").innerText = '최하위 경로의 카테고리명 (=' + categoryNameValue + ')만 수정됩니다.';
            document.getElementById("newCategoryName").value = categoryNameValue;
        }

        function saveCategory(event) {
            event.preventDefault();

            const categoryName = document.getElementById("categoryName").value;
            const parentCategoryName = document.getElementById("parentCategoryName").value;
            const parentCategoryNameValue = document.getElementById("parentCategoryNameValue").value;

            if(categoryName.includes(" ")){
                alert('공백은 포함할 수 없습니다.');
                return;
            }

            if (confirm('카테고리를 등록하시겠습니까? \n\n상위카테고리:' + parentCategoryName + '\n카테고리명 : ' + categoryName)) {
                fetch(`/admin/categories/register?categoryName=` + categoryName + '&parentCategoryName=' + parentCategoryNameValue, {
                    method: 'POST'
                })
                    .then(response => {
                        if (response.ok) {
                            alert('성공적으로 등록되었습니다.');
                            location.reload();
                        }else if(response.status === 409){
                            alert('이미 존재하는 카테고리명입니다.');
                        } else if(response.status === 404){
                            alert('상위 카테고리를 찾을 수 없습니다.\n잠시 후 다시 시도해 주세요.')
                        }
                        else {
                            alert('카테고리 등록에 실패하였습니다.\n잠시 후 다시 시도해주세요.');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while deleting the phone number..');
                    });
            }
        }

        function updateCategory(event) {
            event.preventDefault(); // Prevent form submission

            const currentCategoryName = document.getElementById("currentCategoryName").value;
            const currentCategoryNameValue = document.getElementById("currentCategoryNameValue").value;
            const newCategoryName = document.getElementById("newCategoryName").value;

            if(newCategoryName.includes(" ")){
                alert('공백은 포함할 수 없습니다.');
                return;
            }

            if (newCategoryName === currentCategoryNameValue){
                alert('기존과 동일한 카테고리명입니다.');
                return;
            }

            if (confirm('카테고리를 수정하시겠습니까? \n\n변경 전 : ' + currentCategoryName + '\n변경 후 : ' + newCategoryName)) {
                fetch(`/admin/categories/update?currentCategoryName=` + currentCategoryNameValue +'&newCategoryName=' + newCategoryName, {
                    method: 'PUT'
                })
                    .then(response => {
                        if (response.ok) {
                            alert('성공적으로 수정되었습니다.');
                            location.reload();
                        }else if(response.status === 409){
                            alert('이미 존재하는 카테고리명입니다.');
                        } else {
                            alert('카테고리 수정에 실패하였습니다.\n잠시 후 다시 시도해주세요.');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while deleting the phone number..');
                    });
            }
        }
    </script>
</head>
<body>

<main class="main-content flex-grow-1" style="padding-top: 50px; padding-bottom: 50px;">
    <div class="container mx-auto max-w5xl">
        <div class="card shadow-sm">
            <h1 class="text-2xl font-bold"><a href="/admin/categories">Categories</a></h1>
        </div>
        <div class="card-body">
            <div class="mb-4">
                <div class="admin-category-add-container">
                    <h2 class="text-lg font-semibold" style="display: inline-block">카테고리</h2>
                    <div class="admin-category-add-btn" data-bs-toggle="modal" data-bs-target="#registerCategoryModal" onclick="openRegisterCategoryModal(null, null)"> 신규 최상위 카테고리 추가 </div>
                </div>
                <div class="pagination">
                    <div class="col-sm-6 offset-sm-2 offset-md-0 col-lg-5 d-none d-lg-block" >
                        <div class="search-bar border rounded-2 px-3 border-dark-subtle">
                            <form id="search-form" class="text-center d-flex align-items-center" action="/admin/categories/containing2" method="get">
                                <input type="text" name="categoryName" class="form-control border-0 bg-transparent"
                                       placeholder="Search Category" required/>
                                <button type="submit" class="search-form">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                                        <path fill="currentColor"
                                              d="M21.71 20.29L18 16.61A9 9 0 1 0 16.61 18l3.68 3.68a1 1 0 0 0 1.42 0a1 1 0 0 0 0-1.39ZM11 18a7 7 0 1 1 7-7a7 7 0 0 1-7 7Z" />
                                    </svg>
                                </button>
                            </form>
                        </div>
                        <span th:text="'total : ' + ${totalCount}"></span>
                    </div>
                </div>
                <div th:unless="${empty}" class="pagination">
                    <a th:class="'active'" th:href="${url}+ '&sort=productCategoryId'">등록순</a>
                    <a th:class="'active'" th:href="${url}+ '&sort=categoryName'">이름순(역순)</a>
                    <a th:class="'active'" th:href="${url}+ '&sort=categoryName&desc=false'">이름순</a>
                </div>
                <div class="pagination" th:each="category : ${categoryNamePage}">
                    <label></label>
                    <textarea class="category-form-control" th:text="${category.getValue()}" style="resize: none; width: 600px" readonly></textarea>
                    <div class="admin-category-add-btn"  th:categoryId="${category.getKey().productCategoryId()}" onclick="getAllSubCategory(this.getAttribute('categoryId'))">하위 카테고리 조회</div>
                    <div class="admin-category-add-btn" th:parentCategoryName="${category.getValue()}" th:parentCategoryNameValue="${category.getKey().categoryName()}" onclick="openRegisterCategoryModal(this.getAttribute('parentCategoryName'), this.getAttribute('parentCategoryNameValue'))" data-bs-toggle="modal" th:on data-bs-target="#registerCategoryModal">하위 카테고리 추가</div>
                    <div class="admin-category-add-btn" th:categoryName="${category.getValue()}" th:categoryNameValue="${category.getKey().categoryName()}" onclick="openUpdateCategoryModal(this.getAttribute('categoryName'), this.getAttribute('categoryNameValue'))" data-bs-toggle="modal" th:on data-bs-target="#updateCategoryModal"> 수정</div>
                </div>
            </div>
        </div>
    </div>
    <div th:unless="${empty}" class="pagination" th:attr="data-total-pages=${totalPage},data-current-page=${page}">
                <span th:if="${page > 1}">
                    <a th:href="${url} + 'page=' + ${page - 1} + ${sort == null ? '' : '&sort=' + sort} + ${desc == null ? '' : '&desc=' + desc}">Previous</a>
                </span>
        <span th:each="pageNum : ${#numbers.sequence(1, totalPage)}">
                    <a th:if="${pageNum == page}" th:text="${pageNum}" th:class="'active'"></a>
                    <a th:if="${pageNum != page}" th:href="${url} + 'page=' + ${pageNum} + ${sort == null ? '' : '&sort=' + sort} + ${desc == null ? '' : '&desc=' + desc}" th:text="${pageNum}"></a>
                </span>
        <span th:if="${page < totalPage}">
                    <a th:href="${url} + 'page=' + ${page + 1}+ ${sort == null ? '' : '&sort=' + sort} + ${desc == null ? '' : '&desc=' + desc}">Next</a>
                </span>
    </div>
    <div th:if="${empty}">
        <div class="mb-4 text-center border" >
            <h3>검색 결과가 없습니다.</h3>
        </div>
    </div>
</main>
</body>
<div class="modal fade" id="registerCategoryModal" tabindex="-1" aria-labelledby="registerCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addAddressModalLabel">Save new Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form onsubmit="saveCategory(event)">
                <div class="modal-body">
                    <div class="form-group">
                        <label>상위카테고리</label>
                        <input type="text" class="form-control" name="parentCategoryName" id="parentCategoryName" readonly/>
                        <input type="hidden" class="form-control" name="parentCategoryNameValue" id="parentCategoryNameValue"/>
                        <label>카테고리명</label>
                        <input type="text" class="form-control" name="categoryName" id="categoryName"  required />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="submit" class="btn btn-primary">저장</button>
                </div>
            </form>
        </div>
    </div>
</div>
<div class="modal fade" id="updateCategoryModal" tabindex="-1" aria-labelledby="updateCategoryLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="updateCategoryLabel">Update Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form onsubmit="updateCategory(event)">
                <div class="modal-body">
                    <div class="form-group">
                        <label>기존 카테고리명</label>
                        <input type="text" class="form-control" name="currentCategoryName" id="currentCategoryName"  readonly />
                        <input type="hidden" class="form-control" name="currentCategoryNameValue" id="currentCategoryNameValue"  readonly />

                        <label>새로운 카테고리명</label>
                        <input type="text" class="form-control" name="newCategoryName" id="newCategoryName" required />
                        <span id="innerText" style="font-size: 12px; color: #6c757d"></span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="submit" class="btn btn-primary">저장</button>
                </div>
            </form>
        </div>
    </div>
</div>
</html>